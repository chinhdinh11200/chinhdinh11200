name: happy_coding

on:
  schedule:
    - cron: "0 0 1 1 *"
  workflow_dispatch: # Allows manual trigger for testing

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update happy-code section
        run: |
          YEAR=$(date +%Y)
          ENTRY="    <p>Happy code for $YEAR</p>"

          for file in README.md README.md.template; do
            if grep -q "$ENTRY" "$file"; then
              echo "Already exists"
              continue
            fi
            awk -v entry="$ENTRY" '
              /<div id="happy-code" align="center">/ {
                print
                print entry
                next
              }
              { print }
            ' "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
          done

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README.md.template
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸŽ‰ Happy code for $(date +%Y)" && git push)
